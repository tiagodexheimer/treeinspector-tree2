generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis, unaccent]
}

model Species {
  id_especie      Int       @id @default(autoincrement())
  nome_comum      String
  nome_cientifico String    @unique
  family          String?
  native_status   String?
  gbif_id         BigInt?
  plantnet_id     String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  description     String?
  growth_rate     String?
  max_height_m    Decimal?
  porte           TreeSize?
  trees           Tree[]
}

model User {
  id                    String         @id @default(cuid())
  name                  String?
  email                 String         @unique
  password              String
  role                  Role           @default(OPERACIONAL)
  active                Boolean        @default(true)
  created_at            DateTime       @default(now())
  updated_at            DateTime       @updatedAt
  inspectionsCreated    Inspection[]   @relation("InspectionCreator")
  serviceOrdersAssigned ServiceOrder[] @relation("ServiceOrderAssignee")
  serviceOrdersCreated  ServiceOrder[] @relation("ServiceOrderCreator")
}

model Tree {
  id_arvore       Int                      @id @default(autoincrement())
  uuid            String?                  @unique
  numero_etiqueta String?
  nome_popular    String?
  cover_photo     String?
  localizacao     Unsupported("geometry")?
  rua             String?
  numero          String?
  bairro          String?
  endereco        String?
  speciesId       Int
  created_at      DateTime                 @default(now())
  updated_at      DateTime                 @updatedAt
  status          String                   @default("Ativa")
  inspections     Inspection[]
  photos          PhotoMetadata[]
  species         Species                  @relation(fields: [speciesId], references: [id_especie])
  serviceOrders   ServiceOrder[]           @relation("ServiceOrderToTree")
}

model Inspection {
  id_inspecao       Int                 @id @default(autoincrement())
  uuid              String?             @unique
  data_inspecao     DateTime            @default(now())
  treeId            Int
  created_at        DateTime            @default(now())
  createdById       String?
  tree_removed      Boolean             @default(false)
  dendrometrics     DendrometricData[]
  createdBy         User?               @relation("InspectionCreator", fields: [createdById], references: [id])
  tree              Tree                @relation(fields: [treeId], references: [id_arvore])
  photos            InspectionPhoto[]
  managementActions ManagementAction[]
  phytosanitary     PhytosanitaryData[]

  @@index([treeId])
  @@index([data_inspecao])
}

model DendrometricData {
  id             Int        @id @default(autoincrement())
  inspectionId   Int
  dap1_cm        Decimal?
  dap2_cm        Decimal?
  dap3_cm        Decimal?
  dap4_cm        Decimal?
  altura_total_m Decimal?
  altura_copa_m  Decimal?
  valid_from     DateTime
  valid_to       DateTime?
  inspection     Inspection @relation(fields: [inspectionId], references: [id_inspecao])

  @@index([inspectionId])
}

model PestCatalog {
  id                Int                 @id @default(autoincrement())
  nome_comum        String              @unique
  nome_cientifico   String?
  tipo              String?
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  phytosanitaryData PhytosanitaryData[] @relation("PestCatalogToPhytosanitaryData")
}

model PhytosanitaryData {
  id               Int              @id @default(autoincrement())
  inspectionId     Int
  estado_saude     String?
  severity_level   Int?
  risk_probability RiskProbability?
  target_value     Int?
  risk_rating      Int?
  danos_tipo       String?
  valid_from       DateTime
  valid_to         DateTime?
  inspection       Inspection       @relation(fields: [inspectionId], references: [id_inspecao])
  pests            PestCatalog[]    @relation("PestCatalogToPhytosanitaryData")

  @@index([inspectionId])
}

model ManagementAction {
  id               Int            @id @default(autoincrement())
  inspectionId     Int
  necessita_manejo Boolean        @default(false)
  manejo_tipo      String?
  poda_tipos       String[]
  supressao_tipo   String?
  justification    String?
  valid_from       DateTime
  valid_to         DateTime?
  created_at       DateTime       @default(now())
  inspection       Inspection     @relation(fields: [inspectionId], references: [id_inspecao])
  serviceOrders    ServiceOrder[] @relation("ManagementActionToServiceOrder")

  @@index([inspectionId])
}

model ServiceOrder {
  id                Int                    @id @default(autoincrement())
  status            String
  assigned_to       String?
  observations      String?
  description       String?
  serviceType       String?
  serviceSubtypes   String[]
  created_at        DateTime               @default(now())
  executed_at       DateTime?
  adjustment_notes  String?
  assignedToId      String?
  cancel_reason     String?
  checklist         Json?
  createdById       String?
  priority          ServicePriority        @default(Moderada)
  start_time        DateTime?
  team_size         Int                    @default(1)
  assignedTo        User?                  @relation("ServiceOrderAssignee", fields: [assignedToId], references: [id])
  createdBy         User?                  @relation("ServiceOrderCreator", fields: [createdById], references: [id])
  materials         ServiceOrderMaterial[]
  photos            ServiceOrderPhoto[]
  managementActions ManagementAction[]     @relation("ManagementActionToServiceOrder")
  trees             Tree[]                 @relation("ServiceOrderToTree")

  @@index([status])
  @@index([assigned_to])
}

model ServiceOrderPhoto {
  id             Int           @id @default(autoincrement())
  serviceOrderId Int
  uri            String
  created_at     DateTime      @default(now())
  category       PhotoCategory @default(Depois)
  serviceOrder   ServiceOrder  @relation(fields: [serviceOrderId], references: [id])
}

model ServiceOrderMaterial {
  id             Int          @id @default(autoincrement())
  serviceOrderId Int
  name           String
  quantity       Decimal
  unit           String?
  unit_cost      Decimal      @default(0)
  serviceOrder   ServiceOrder @relation(fields: [serviceOrderId], references: [id])
}

model MaterialMaster {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  unit       String
  unit_cost  Decimal  @default(0)
  auto_load  Boolean  @default(false)
  active     Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model PhotoMetadata {
  id          Int      @id @default(autoincrement())
  blob_url    String
  blob_key    String?
  file_name   String
  file_size   Int?
  mime_type   String?
  tree_id     Int?
  captured_at DateTime @default(now())
  uploaded_at DateTime @default(now())
  capture_lat Float?
  capture_lng Float?
  tree        Tree?    @relation(fields: [tree_id], references: [id_arvore])

  @@index([tree_id])
}

model InspectionPhoto {
  id_foto      Int        @id @default(autoincrement())
  inspectionId Int
  uri          String
  created_at   DateTime   @default(now())
  is_cover     Boolean    @default(false)
  inspection   Inspection @relation(fields: [inspectionId], references: [id_inspecao])
}

model SystemSettings {
  id         Int      @id @default(autoincrement())
  key        String   @unique
  value      String
  updated_at DateTime @updatedAt
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum TreeSize {
  Pequeno
  Medio
  Grande
}

enum Role {
  ADMIN
  GESTOR
  INSPETOR
  OPERACIONAL
}

enum RiskProbability {
  Baixa
  Moderada
  Alta
  Extrema
  MUITO_PROVAVEL
  PROVAVEL
  POSSIVEL
  IMPROVAVEL
  IMINENTE
  IMPROVAVEL_X
}

enum ServicePriority {
  Baixa
  Moderada
  Alta
  Emergencial
}

enum PhotoCategory {
  Antes
  Durante
  Depois
}
